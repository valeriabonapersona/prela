---
title: "Prela - numbers for paper"
author: "Valeria Bonapersona"
date: "11/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(metafor) # for meta-analysis related things
library(knitr) # for pretty talbes in markdown
options(scipen=1, digits=3)
```

```{r env preparation}
source("config/utilities.R")
source("src/general_funs.R")

dat_unprocessed <- readRDS(paste0(temp, "prela_data_unprocessed.RDS"))
## remove in previous files
dat_unprocessed <- dat_unprocessed %>% 
  filter(age_testing_weeks < 53 | is.na(age_testing_weeks)) %>% 
  mutate(
    origin = ifelse(origin == "isolation", "not_specified", origin), 
    model = ifelse(exp_id %in% paste0("12140784_", c(1:4)), "maternal_deprivation", model),
    model = ifelse(separation_hours == "24", "maternal_deprivation", model), 
    separation_light_phase = ifelse(id == "25288769", "not_specified", separation_light_phase)
    ) ## also double check

## exp information
exp <- readRDS(paste0(temp, "info_experiments.RDS"))
exp <- exp %>% 
  mutate(model = ifelse(exp_id %in% paste0("12140784_", c(1:4)), "maternal_deprivation", model), 
         model = ifelse(separation_hours == "24", "maternal_deprivation", model), 
         separation_light_phase = ifelse(id == "25288769", "not_specified", separation_light_phase)) # move to previous

## behavior
mab_full <- read.csv("~/surfdrive/Work/PhD/MAB/MAB_Analysis/MAB_dataRepository/MAB_data.csv", sep = ";")
```

```{r epinephrine df}
temp_path <- "~/surfdrive/Work/PhD/mELA_materials/Eline/all_files_mELA_2020/5. Files/outcomes_mELA_VB_v3.xlsx"
dat_xl <- read_my_sheets(temp_path, c("publications","experiments", "out_plasma"))

plasma_epi <- dat_xl[["out_plasma"]] %>% 
  left_join(dat_xl$exp, by = "exp_id") %>% 
  rename(
    mean_e = estimate_e, 
    mean_c = estimate_c, 
    sem_e = deviation_e, 
    sem_c = deviation_c
  ) %>% 
  mutate(
    sem_c = ifelse(sem_c == "not_specified", sem_e, sem_c), 
    sem_c = as.numeric(sem_c),
    sd_c = sem_c * sqrt(n_c),
    sd_e = sem_e * sqrt(n_e)
  ) %>% 
  filter(outcome == "E")
```


## Info for PRISMA - fig 1
Number of included studies that met all inclusion criteria (neurobiology): `r n_distinct(dat_unprocessed$id)`
Number of included studies that met all inclusion criteria (behavior): `r n_distinct(mab_full$id)`


The table below indicates the numbers of independent studies, experiments and comparisons for each domain. 


```{r prisma info table}
prisma_neurobio <- dat_unprocessed %>% 
  mutate(domain = ifelse(domain %in% c("other_ieg", "c_fos"), "ieg", domain)) %>% 
  group_by(domain) %>% 
  summarize(across(ends_with("id"), function(x) length(unique(x))), 
            .groups = "drop") %>% 
  filter(!is.na(domain), domain != "NA")

prisma_epi <- plasma_epi %>% 
  mutate(domain = "plasma_epi") %>% 
  group_by(domain) %>% 
  summarize(across(ends_with("id"), function(x) length(unique(x))), 
            .groups = "drop")

prisma_behav <- mab_full %>% 
  rename(exp_id = exp, 
         outcome_id = each) %>%
  mutate(
    domain = case_when(
      anxiety == 1 ~ "anxiety", 
      sLearning == 1 ~ "stressful_learning", 
      nsLearning == 1 ~ "nonstressful_learning", 
      social == 1 ~ "social", 
      T ~ "other_behavior"
    )
  ) %>%  
  group_by(domain) %>% 
  summarize(across(ends_with("id"), function(x) length(unique(x))), 
            .groups = "drop") 

prisma_full <- bind_rows(prisma_neurobio, prisma_behav) %>% 
  bind_rows(prisma_epi)
```


## Population
`r dat_unprocessed %>% filter(is.na(age_testing_weeks)) %>% pull(id) %>% unique() %>% length()` publications did not specify the actual age of experimental animals (only that they were adult). 

`r exp %>% filter(species == "rat") %>% nrow()` experiments (`r exp %>% filter(species == "rat") %>% nrow() / n_distinct(exp$exp_id) * 100`%) were in rats (Figure 1 A). `r n_distinct(exp$strain)` strains of rats and mice were used, of which Wistar rats and C57Bl/6 mice were the most common. 

~`r dat_unprocessed %>% group_by(exp_id) %>% summarize(ntot = mean(n_c) + mean(n_e), .groups = "drop") %>% summarize(sum(ntot)) %>% round()` animals were used, `r dat_unprocessed %>% filter(sex == "male") %>% group_by(exp_id) %>% summarize(ntot = mean(n_c) + mean(n_e), .groups = "drop") %>% summarize(sum(ntot)) %>% round()` (`r dat_unprocessed %>% filter(sex == "male") %>% group_by(exp_id) %>% summarize(ntot = mean(n_c) + mean(n_e), .groups = "drop") %>% summarize(100*sum(ntot)/(dat_unprocessed %>% group_by(exp_id) %>% summarize(ntot = mean(n_c) + mean(n_e), .groups = "drop") %>% summarize(sum(ntot))))`%) of which were males. 



```{r hist funs}
my_hist <- geom_histogram(stat="count", color = "black")
```

```{r pop graphs, fig.height=6, fig.width=8, warning=FALSE}
## Figure 1
g_pop <- list()
g_pop[["age"]] <- dat_unprocessed %>% 
    ggplot(aes(age_testing_weeks)) + 
    labs(y = expression("N"["comparisons"]), x = "Weeks", title = "Age") +
    my_hist +
    scale_fill_manual(values = rep("white", 
                                   n_distinct(dat_unprocessed$id))) + 
  my_theme

g_pop[["strain"]] <- dat_unprocessed %>% 
  mutate(strain = str_replace_all(strain, "_", " \n "), 
         strain = ifelse(strain == "long \n evans \n hooded", "long evans \n hooded", strain)) %>%
  ggplot(aes(factor(strain, 
  levels = c("c57bl6", "balbc", "swiss \n webster", "cd1", "other", 
             "wistar", "sprague \n dawley", "long \n evans", 
             "lister \n hooded", "long evans \n hooded", 
             "not \n specified")), fill = id)) + 
  labs(y = expression("N"["comparisons"]), 
       x = "Strain", 
       title = "Species"
      ) + 
  my_hist + my_theme + 
  facet_grid(~fct_rev(species), scales = "free_x") + 
  scale_fill_manual(values = rep("white", n_distinct(dat_unprocessed$id))) + 
  theme(legend.position = "none")

g_pop[["model"]] <- dat_unprocessed %>% 
  mutate(
    model = str_replace_all(model, "_", " \n ")) %>%
  ggplot(aes(factor(model, levels = c("maternal \n separation", "maternal \n deprivation", "isolation", "limited \n nesting", "licking \n grooming")), fill = id)) + 
  labs(
    y = expression("N"["comparisons"]), 
    x = "ELA model", 
    title = "ELA model"
    ) + 
   my_hist + my_theme + 
  scale_fill_manual(values = rep("white", n_distinct(dat_unprocessed$id))) + 
  theme(legend.position = "null")


# other life

df_life <- dat_unprocessed %>% 
  select(exp_id, origin, behavior, housing_after_weaning,
         major_life_events, trauma_presence) %>%
  unique() %>%
  pivot_longer(cols = c(-exp_id), names_to = "vars") %>%
  group_by(vars, value) %>% 
  summarise(
    n = length(exp_id), 
    perc = n/length(unique(dat_unprocessed$exp_id))*100, 
    .groups = "drop"
  ) %>%
  mutate(
    y_pos = n/2,
    lab = str_replace_all(value, "_", " "),
    lab = case_when(
      lab == "not specified" ~ "not \n specified", 
      lab == "purchased pregnant dams" ~ "purchased \n pregnant dams", 
      lab == "purchased naive parents" ~ "purchased \n na√Øve parents", 
      lab == "non stressful" ~ "non \n stressful",
      T ~ lab
    ),
    vars = ifelse(vars == "trauma_presence", "other trauma", vars), 
     my_fill = ifelse(value %in% c("yes", "purchased_pregnant_dams", "stressful"), "yes", "no")
    )

g_pop[["life"]] <- df_life %>%
  ggplot(aes(str_replace_all(vars, "_", " "), y = perc, label = lab, fill = my_fill)) + 
  geom_bar(stat = "identity", colour = "black") +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) + 
  labs(
    y = "% experiments", 
    x = "", 
    title = "Life events"
    ) + 
  my_theme +
  theme(legend.position = "null") + 
  scale_fill_manual(values = c("white", "grey90")) + 
  coord_flip()
  
```

```{r fig 1, fig.height=6, fig.width=8, warning=FALSE}
# put together
ggpubr::ggarrange(
  ggpubr::ggarrange(
    g_pop[["strain"]],
    g_pop[["age"]], 
    g_pop[["model"]], widths = c(1.4, 1, 1),
    ncol = 3, nrow = 1, labels = c("A", "B", "C")
  ), 
  g_pop[["life"]],
  nrow = 2,  heights = c(1.3,1), 
  labels = c("", "D")
)

ggpubr::ggarrange(
  ggpubr::ggarrange(
    g_pop[["strain"]],
    g_pop[["age"]], widths = c(1.5, 1),
    ncol = 2, nrow = 1, labels = c("A", "B")
  ), 
  
  ggpubr::ggarrange(
    g_pop[["model"]],
    g_pop[["life"]],
    ncol = 2,  widths = c(1,1.7), 
    labels = c("C", "D")
  ), 
  nrow = 2, heights = c(1.2, 1)
)

```


## Model
```{r early life info}
lit_size <- exp %>% 
  filter(litter_size!= "not_specified") %>% 
  select(litter_size) %>% 
  separate(litter_size, 
           into = c("litter_1", "litter_2"), 
           remove = FALSE, sep = "_") %>% 
  rowwise() %>% 
  mutate(size = mean(c(as.numeric(litter_1), 
                       as.numeric(litter_2)), na.rm = T))

mat_sep <- exp %>% 
  filter(model == "maternal_separation") %>% 
  mutate(separation_hours = ifelse(separation_hours == "5_6", "5.5", separation_hours),
         separation_hours = as.numeric(separation_hours))

matsep_P <- mat_sep %>% 
  select(exp_id, model_postdays) %>% 
  separate(model_postdays, into = c("p_1", "p_2")) %>%
  rowwise() %>%
  mutate(p_1 = as.numeric(p_1), 
         p_2 = as.numeric(p_2), 
         p_length = p_2 - p_1) %>% 
  arrange(p_1, p_2)
```


Concerning the early life environment, cross-fostering was reported to be used in `r n_distinct(exp[exp$cross_fostering == "yes",]$exp_id)` experiments (`r n_distinct(exp[exp$cross_fostering == "yes",]$exp_id)/n_distinct(exp$exp_id)*100`%). Litter size (and therefore culling) was specified in `r n_distinct(exp[exp$litter_size != "not_specified",]$exp_id)` experiments (`r n_distinct(exp[exp$litter_size != "not_specified",]$exp_id) / n_distinct(exp$exp_id)*100`%). Litters ranged between `r min(lit_size$size)` and `r max(lit_size$size)` animals, with a median of `r median(lit_size$size)` animals per litter.

`r n_distinct(exp[exp$model != "licking_grooming",]$model)` ELA models were used to induce ELA, namely maternal separation, maternal deprivation, isolation and licking and grooming. Alongside these induction models, licking and grooming was used to describe natural variation in the population. Specifically, we considered low licking and grooming as "negative" / ELA-like. 


Maternal separation was the ELA model most used (n~exp~ = `r n_distinct(exp[exp$model == "maternal_separation",]$exp_id)`, `r n_distinct(exp[exp$model == "maternal_separation",]$exp_id) / n_distinct(exp$exp_id)*100`%). In all experiments using maternal separation, the induction started in the first postnatal week. `r sum(matsep_P$p_2 <= 7, na.rm = T)` experiments (`r sum(matsep_P$p_2 <= 7, na.rm = T) / nrow(matsep_P)*100`%) used maternal separation only in the first postnatal week, `r sum(matsep_P$p_2 > 7 & matsep_P$p_2 <= 14, na.rm = T)` experiments (`r sum(matsep_P$p_2 > 7 & matsep_P$p_2 <= 14, na.rm = T) / nrow(matsep_P)*100`%) in the second, and `r sum(matsep_P$p_2 > 14, na.rm = T)` experiments (`r sum(matsep_P$p_2 > 14, na.rm = T) / nrow(matsep_P)*100`%) to the third. The average (as well as median) length of the maternal separation model was `r round(mean(matsep_P$p_length))` days. The average separation length for maternal separation was `r mean(mat_sep$separation_hours)` hours per day. In `r n_distinct(mat_sep[mat_sep$separation_repetition == "unpredictable",]$exp_id)` experiments (`r n_distinct(mat_sep[mat_sep$separation_repetition == "unpredictable",]$exp_id) / n_distinct(mat_sep$exp_id)*100`%), the timing of separation was unpredictable, whereas for the remaining separation occurred at the same time every day. In the majority of experiments (n~exp~ = `r n_distinct(mat_sep[mat_sep$separation_light_phase == "light",]$exp_id)`, `r n_distinct(mat_sep[mat_sep$separation_light_phase == "light",]$exp_id) / n_distinct(mat_sep$exp_id)*100`%), separation occurred during the light phase. ~ `r n_distinct(mat_sep[mat_sep$separation_light_phase == "not_specified",]$exp_id) / n_distinct(mat_sep$exp_id)*100`% did not specify in which light phase the separation occurred. 


## Other life events

`r dat %>% filter(naive == "yes") %>% pull(exp_id) %>% unique() %>% length()` experiments (`r dat %>% filter(naive == "yes") %>% pull(exp_id) %>% unique() %>% length() / n_distinct(dat$exp_id) * 100`%) were conducted on naive animals. In the remaining experiments, the animals experienced various life events, which have been categorized in Figure 1D. 

In `r n_distinct(exp[exp$trauma_presence == "yes",]$exp_id)` experiments (`r n_distinct(exp[exp$trauma_presence == "yes",]$exp_id)/n_distinct(exp$exp_id)*100`%), control and experimental group experienced life events that could be considered traumatic. For example, the dams of  `r n_distinct(exp[exp$origin == "purchased_pregnant_dams",]$exp_id)` experiments (`r n_distinct(exp[exp$origin == "purchased_pregnant_dams",]$exp_id)/n_distinct(exp$exp_id)*100`%) were purchased pregnant, and therefore underwent transportation stress during pregnancy. For the pups, this may be for the pups a prenatal stressor that interacts with the postnatal life events. In  `r n_distinct(exp[exp$major_life_events == "yes",]$exp_id)` experiments (`r n_distinct(exp[exp$major_life_events == "yes",]$exp_id)/n_distinct(exp$exp_id)*100`%), the control and experimental groups experienced chronic negative life events, such as chronic unpredictable stress or chronic restraint / immobilization. Lastly, the animals of `r n_distinct(exp[exp$behavior != "no_behavior",]$exp_id)` experiments (`r n_distinct(exp[exp$behavior != "no_behavior",]$exp_id)/n_distinct(exp$exp_id)*100`%) performed behavior tests. Of these, `r n_distinct(exp[exp$behavior != "stressful",]$exp_id)` experiments (`r n_distinct(exp[exp$behavior != "stressful",]$exp_id)/n_distinct(exp$exp_id)*100`% of total) included stressful behavioral paradigms, such as fear conditioning or forced swim test. 

A minority of experiments (n~exp~ = `r n_distinct(exp[exp$housing_after_weaning == "single",]$exp_id)`, `r n_distinct(exp[exp$housing_after_weaning == "single",]$exp_id)/n_distinct(exp$exp_id)*100`%) single housed animals after weaning. This was not used for the classification of multiple hits. 

Besides the major life events experienced during life which may have a long lasting effect, the animals also had different acute experiences at the moment of death. The majority of studies killed the animals under "rest" or "mildly aroused" conditions (`r n_distinct(dat[dat$at_death == "no",]$exp_id)`, `r n_distinct(dat[dat$at_death == "no",]$exp_id)/n_distinct(dat$exp_id)*100`%), whereas others after stressful experiences, such as restraint, forced swim test or recollection phase of the fear conditioning paradigm.

>> Check AT DEATH VARIABLE

The above mentioned factors (i.e. transport stress prenatally, major chronic life events, stress behavioral tasks) could be cumulatively considered as "hits". 

```{r cvr effect}
overall_effect_cvr <- rma.mv(
    yi_cvr, vi_cvr, 
    random = ~1|exp_id,
    data = dat)
```


```{r trauma as hits fig, fig.height=6, fig.width=8}
dat_hits <- dat %>%
  select(exp_id, out_grouped, model, separation_hours, separation_repetition, origin, major_life_events, behavior, yi, vi, yi_cvr, vi_cvr, ends_with("_c"), ends_with("_e")) %>% 
  mutate(
    origin_num = ifelse(origin == "purchased_pregnant_dams", 1, 0), 
    major_life_events_num = ifelse(major_life_events == "yes", 1, 0), 
    behavior_num = ifelse(behavior == "stressful", 1, 0)
  ) %>% 
  rowwise() %>% 
  mutate(
    trauma_score = factor(sum(origin_num, major_life_events_num, behavior_num), levels = c("0", "1", "2", "3"))
  )

g_hits <- dat_hits %>% 
  mutate(trauma_score = paste0("+", trauma_score)) %>% 
  ggplot(aes(trauma_score)) + 
  my_hist + my_theme + 
  scale_fill_manual(values = "white") + 
  labs(y = expression("N"["comparisons"]), x = expression("N"["hits"]), title = "Multiple hits")

# select only outcomes with all traumas

dat_hits_complete <- dat_hits %>% 
  filter(!is.na(yi_cvr), !is.na(vi_cvr)) %>%
  mutate(trauma_score = paste0("t_", trauma_score)) %>% 
  group_by(out_grouped, trauma_score) %>% 
  count() %>%
  pivot_wider(names_from = trauma_score, values_from = n) %>%
  drop_na() %>% 
  select(out_grouped) %>% 
  left_join(dat_hits) %>% 
  mutate(aggr = paste0(out_grouped, trauma_score))


mod_hits_complete_cvr <- rma.mv(
  yi_cvr, vi_cvr, 
  random = ~1|exp_id,
  data = dat_hits_complete, 
  mods = ~ trauma_score - 1)

hits_complete_cvr_df <- data.frame(
  trauma_score = paste0("+",c(0:3)), 
  estimate = mod_hits_complete_cvr$b, 
  se = mod_hits_complete_cvr$se, 
  pval = mod_hits_complete_cvr$pval,
  ci_low = mod_hits_complete_cvr$ci.lb,
  ci_high = mod_hits_complete_cvr$ci.ub, 
  n_comp = dat_hits_complete %>% group_by(trauma_score) %>% count() %>% pull(n)
) %>% 
  mutate(
    sig = case_when(
      pval < 0.001 ~ "***", 
      pval < 0.01 ~ "**", 
      pval < 0.05 ~ "*", 
      T ~ ""
    )
  )

g_hits_cvr <- hits_complete_cvr_df %>% 
  
  ggplot(aes(trauma_score, estimate)) + 
  geom_bar(stat = "identity", colour = "black") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2) +
  
  # beautiful
  ylim(c(-0.4,0.5)) +
  my_theme +
  labs(x=expression("N"["additional hits"]), y = "CVR[CI]",
      title = "Variation across multiple hits") +
  scale_fill_manual(values = c("white")) + 
  geom_text(aes(label = n_comp),y = -0.3, parse = T) +
  geom_text(x = "+0", y = 0.4, aes(label = sig), size = 10)


# correlarion SE(CVR) and n of trauma score
g_secvr_n <- hits_complete_cvr_df %>% 
  ggplot(aes(se, n_comp)) + 
  geom_point(size = 3, aes(color = trauma_score)) +
  labs(x = "SE of CVR", y = expression("N"["comparisons"]), 
       color = "Additional traumas") + 
  my_theme
  
# all plots
ggpubr::ggarrange(
  ggpubr::ggarrange(
     g_hits,
     g_hits_cvr, 
     ncol = 2, nrow = 1, labels = c("A", "B", "C")
  ), 
  g_secvr_n, nrow = 2, labels = c("", "C")
)
```

I selected only those outcomes that had at least one publication in each of the "additional hits" subgroups. In this subset of comparisons, we meta-analysed the CVR, meaning the effect size difference in variation of the ELA group vs control. We used a 3-level meta-analysis with fixed effects on the experiment level.

ELA overall increases variability in the ELA group (see results of overall CVR effect). This was especially true for the +0 additional hits group, whereas when additional hits where experienced, the difference in variability between groups disappeared. Still to do: *compare cvr of +0 with +1 etc with Wald test*.

Of note, in our dataset every experiment compared a control group and a group that experienced early life adversity. Conversely, the experience of other life events is descriptive, and by us categorized based on prior knowledge of the effects of stress on the brain, body and behavior. Therefore, the "life variables" are not homogeneously distributed across outcomes. Implicitly, these variables are not in an experimental design format, therefore causal conclusions cannot be made. 




